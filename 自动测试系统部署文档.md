# AxVisor QEMU 自动测试系统部署文档

**文档版本**：v1.0  
**创建日期**：2026年2月3日  
**作者**：贾一飞

---

## 一、概述

### 1.1 文档目的

本文档描述如何在本地环境中部署和运行 AxVisor QEMU 自动测试系统，实现：
- 在 QEMU 虚拟化环境中测试 AxVisor hypervisor
- 支持多种 Guest 系统（ArceOS、Linux、NimbOS）
- 支持多种架构（aarch64、x86_64）

### 1.2 测试架构

**测试流程：**

1. 构建 AxVisor
2. 下载 Guest 镜像
3. 启动 QEMU，加载 AxVisor + Guest
4. 捕获串口输出
5. 通过 success_regex / fail_regex 判断测试结果

### 1.3 支持的测试组合

| 架构 | Guest 系统 | 状态 | 成功标志 |
|------|-----------|------|----------|
| aarch64 | ArceOS | ✅ 已验证 | `Hello, world!` |
| aarch64 | Linux | ✅ 已验证 | `test pass!` |
| x86_64 | NimbOS | ✅ 已验证（需 VT-x） | `usertests passed!` |

---

## 二、环境要求

### 2.1 必需工具

| 工具 | 最低版本 | 安装方式 | 验证命令 |
|------|----------|----------|----------|
| QEMU (aarch64) | 7.0+ | `sudo apt-get install qemu-system-arm` | `qemu-system-aarch64 --version` |
| QEMU (x86_64) | 7.0+ | `sudo apt-get install qemu-system-x86` | `qemu-system-x86_64 --version` |
| Rust | 1.70+ | [rustup](https://rustup.rs/) | `rustc --version` |
| ostool | ^0.8 | `cargo +stable install ostool --version ^0.8` | `ostool --version` |
| pkg-config | - | `sudo apt-get install pkg-config` | `pkg-config --version` |
| libssl-dev | - | `sudo apt-get install libssl-dev` | - |

### 2.2 可选工具

| 工具 | 用途 | 安装方式 |
|------|------|----------|
| gcc-aarch64-linux-gnu | 从源码构建 aarch64 Guest | `sudo apt-get install gcc-aarch64-linux-gnu` |
| cargo-binutils | Rust 二进制工具 | `cargo install cargo-binutils` |
| libguestfs-tools | rootfs 镜像操作 | `sudo apt-get install libguestfs-tools` |

### 2.3 x86_64 特殊要求

**AxVisor x86_64 必须运行在支持 VT-x/VMX 的环境中：**

| 环境 | 是否支持 | 说明 |
|------|----------|------|
| 物理 Linux 机（VT-x 已启用） | ✅ | 推荐验证环境 |
| 支持嵌套虚拟化的 VM | ✅ | 宿主机需开启 VT-x |
| WSL2 | ❌ | 无 `/dev/kvm`，无法运行 |
| 无 VT-x 的物理机 | ❌ | 无法运行 |

**检查 VMX 是否可用：**

```bash
# 检查 CPU 是否支持 VMX
grep -E 'vmx|svm' /proc/cpuinfo

# 检查 KVM 模块
lsmod | grep kvm

# 检查 /dev/kvm
ls -la /dev/kvm
```

### 2.4 网络与磁盘

- **网络**：首次运行需从 GitHub 下载 Guest 镜像（2.5MB - 17MB）
- **磁盘**：建议预留至少 2GB 可用空间

---

## 三、快速开始

### 3.1 获取源码

```bash
git clone https://github.com/arceos-hypervisor/axvisor.git
cd axvisor
```

### 3.2 安装 ostool

```bash
cargo +stable install ostool --version ^0.8
```

### 3.3 aarch64 ArceOS 测试

```bash
# 准备环境
bash scripts/setup_qemu_arceos.sh

# 运行测试
cargo xtask qemu \
  --build-config configs/board/qemu-aarch64.toml \
  --qemu-config .github/workflows/qemu-aarch64.toml \
  --vmconfigs configs/vms/arceos-aarch64-qemu-smp1.toml
```

**成功标志**：输出 `Hello, world!` 并提示 `Detected success pattern`

### 3.4 aarch64 Linux 测试

```bash
# 准备环境
bash scripts/setup_qemu_linux.sh

# 运行测试
cargo xtask qemu \
  --build-config configs/board/qemu-aarch64.toml \
  --qemu-config .github/workflows/qemu-aarch64.toml \
  --vmconfigs configs/vms/linux-aarch64-qemu-smp1.toml
```

**成功标志**：输出 `test pass!` 并提示 `Detected success pattern`

### 3.5 x86_64 NimbOS 测试（需 VT-x）

```bash
# 准备环境
bash scripts/setup_qemu_nimbos.sh

# 运行测试（使用 KVM 配置）
cargo xtask qemu \
  --build-config configs/board/qemu-x86_64.toml \
  --qemu-config .github/workflows/qemu-x86_64-kvm.toml \
  --vmconfigs configs/vms/nimbos-x86_64-qemu-smp1.toml
```

**成功标志**：输出 `usertests passed!` 并提示 `Detected success pattern`

---

## 四、详细部署步骤

### 4.1 aarch64 ArceOS 手动部署

#### 4.1.1 下载镜像

```bash
cargo xtask image download qemu_aarch64_arceos
ls -la /tmp/axvisor/qemu_aarch64_arceos
# 应包含：qemu-aarch64, rootfs.img
```

#### 4.1.2 修改 VM 配置

编辑 `configs/vms/arceos-aarch64-qemu-smp1.toml`：

```toml
[kernel]
image_location = "memory"
kernel_path = "/tmp/axvisor/qemu_aarch64_arceos/qemu-aarch64"
kernel_load_addr = 0x8020_0000
entry_point = 0x8020_0000
```

#### 4.1.3 准备 rootfs

```bash
mkdir -p tmp
cp /tmp/axvisor/qemu_aarch64_arceos/rootfs.img tmp/rootfs.img
```

#### 4.1.4 运行测试

```bash
cargo xtask qemu \
  --build-config configs/board/qemu-aarch64.toml \
  --qemu-config .github/workflows/qemu-aarch64.toml \
  --vmconfigs configs/vms/arceos-aarch64-qemu-smp1.toml
```

### 4.2 aarch64 Linux 手动部署

#### 4.2.1 下载镜像

```bash
cargo xtask image download qemu_aarch64_linux
ls -la /tmp/axvisor/qemu_aarch64_linux
```

#### 4.2.2 修改 VM 配置

编辑 `configs/vms/linux-aarch64-qemu-smp1.toml`：

```toml
[kernel]
image_location = "memory"
kernel_path = "/tmp/axvisor/qemu_aarch64_linux/qemu-aarch64"
kernel_load_addr = 0x8020_0000
entry_point = 0x8020_0000
```

#### 4.2.3 准备 rootfs

```bash
mkdir -p tmp
cp /tmp/axvisor/qemu_aarch64_linux/rootfs.img tmp/rootfs.img
```

#### 4.2.4 运行测试

```bash
cargo xtask qemu \
  --build-config configs/board/qemu-aarch64.toml \
  --qemu-config .github/workflows/qemu-aarch64.toml \
  --vmconfigs configs/vms/linux-aarch64-qemu-smp1.toml
```

### 4.3 x86_64 NimbOS 手动部署

#### 4.3.1 下载镜像

```bash
cargo xtask image download qemu_x86_64_nimbos
ls -la /tmp/axvisor/qemu_x86_64_nimbos
# 应包含：qemu-x86_64, qemu-x86_64_usertests, rootfs.img
```

#### 4.3.2 准备 rootfs（注入 usertests）

NimbOS 使用 `image_location = "fs"`，需要将内核注入到 rootfs 内部：

```bash
# 需要 libguestfs-tools 或 sudo 权限
bash scripts/setup_qemu_nimbos.sh
```

#### 4.3.3 QEMU 配置选择

**KVM 模式**（需要 VT-x）：

```toml
# .github/workflows/qemu-x86_64-kvm.toml
args = [
  "-m", "128M",
  "-smp", "1",
  "-machine", "q35",
  "-device", "virtio-blk-pci,drive=disk0",
  "-drive", "id=disk0,if=none,format=raw,file=${workspaceFolder}/tmp/rootfs.img",
  "-nographic",
  "-accel", "kvm",
  "-cpu", "host",
]
```

**TCG 模式**（无 VT-x，仅用于构建验证，运行会失败）：

```toml
# .github/workflows/qemu-x86_64.toml
args = [
  ...
  "-accel", "tcg",
  "-cpu", "qemu64",
]
```

#### 4.3.4 运行测试

```bash
cargo xtask qemu \
  --build-config configs/board/qemu-x86_64.toml \
  --qemu-config .github/workflows/qemu-x86_64-kvm.toml \
  --vmconfigs configs/vms/nimbos-x86_64-qemu-smp1.toml
```

### 4.4 切换 Guest 注意事项

ArceOS 和 Linux 共用 `tmp/rootfs.img`，**切换 Guest 前需重新运行对应的 setup 脚本**：

```bash
# 从 Linux 切回 ArceOS
bash scripts/setup_qemu_arceos.sh

# 从 ArceOS 切到 Linux
bash scripts/setup_qemu_linux.sh
```

---

## 五、配置文件说明

### 5.1 配置层次

| 层次 | 目录 | 用途 |
|------|------|------|
| 板级配置 | `configs/board/*.toml` | 构建配置（target、features） |
| QEMU 配置 | `.github/workflows/qemu-*.toml` | QEMU 启动参数、正则匹配 |
| VM 配置 | `configs/vms/*.toml` | Guest 定义（内核、内存、设备） |

### 5.2 板级配置示例

`configs/board/qemu-aarch64.toml`：

```toml
[build]
target = "aarch64-unknown-none"
features = ["axvisor/qemu"]
```

### 5.3 QEMU 配置示例

`.github/workflows/qemu-aarch64.toml`：

```toml
args = [
  "-m", "8G",
  "-smp", "4",
  "-machine", "virt",
  "-cpu", "cortex-a72",
  "-device", "virtio-blk-device,drive=disk0",
  "-drive", "id=disk0,if=none,format=raw,file=${workspaceFolder}/tmp/rootfs.img",
  "-nographic",
]
success_regex = ["Hello, world!", "test pass!"]
fail_regex = ["panicked at"]
```

### 5.4 VM 配置示例

`configs/vms/arceos-aarch64-qemu-smp1.toml`：

```toml
[base]
name = "arceos-qemu"
...

[kernel]
entry_point = 0x8020_0000
image_location = "memory"
kernel_path = "/tmp/axvisor/qemu_aarch64_arceos/qemu-aarch64"
kernel_load_addr = 0x8020_0000

[memory]
...

[devices]
...
```

---

## 六、CI 配置说明

### 6.1 test-qemu.yml 工作流

```yaml
name: QEMU Tests

on: [push, pull_request]

jobs:
  test-aarch64-arceos:
    runs-on: [self-hosted, linux, intel]
    steps:
      - uses: actions/checkout@v4
      - name: Download image
        run: cargo xtask image download qemu_aarch64_arceos
      - name: Run test
        run: |
          cargo xtask qemu \
            --build-config configs/board/qemu-aarch64.toml \
            --qemu-config .github/workflows/qemu-aarch64.toml \
            --vmconfigs configs/vms/arceos-aarch64-qemu-smp1.toml
```

### 6.2 Runner 要求

| 架构 | Runner 标签 | 硬件要求 |
|------|-------------|----------|
| aarch64 | `[self-hosted, linux, intel]` | 可运行 QEMU |
| x86_64 | `[self-hosted, linux, intel]` | 需要 VT-x + KVM |

### 6.3 镜像下载与配置修补

CI 流程中会自动：
1. 下载 Guest 镜像到 `/tmp/axvisor/`
2. 根据 `image_location` 修补 VM 配置
3. 处理 rootfs（复制或移除相关配置）

---

## 七、故障排查

### 7.1 镜像下载失败

**现象**：`cargo xtask image download` 报错

**解决方案**：
1. 检查网络：`ping github.com`
2. 配置代理：
   ```bash
   export http_proxy=http://proxy:8080
   export https_proxy=http://proxy:8080
   ```
3. 手动下载：从 [axvisor-guest releases](https://github.com/arceos-hypervisor/axvisor-guest/releases) 下载并解压到 `/tmp/axvisor/<镜像名>/`

### 7.2 找不到 kernel_path 或 rootfs

**现象**：`ERROR: kernel image not found` 或 `Could not open 'tmp/rootfs.img'`

**解决方案**：
1. 确认已运行对应的 setup 脚本
2. 检查 VM 配置中 `kernel_path` 是否正确
3. 确认 `tmp/rootfs.img` 存在

### 7.3 ostool 版本不匹配

**现象**：`cargo xtask qemu` 报错

**解决方案**：
```bash
cargo +stable install ostool --version ^0.8
cargo install --list | grep ostool
```

### 7.4 未检测到成功模式

**现象**：QEMU 超时退出，未出现 `Detected success pattern`

**解决方案**：
1. 查看完整 QEMU 输出，确认 Guest 是否正常启动
2. 检查 `success_regex` 配置是否与实际输出匹配
3. 增加 QEMU 内存（`-m` 参数）

### 7.5 x86_64 VMX 不支持

**现象**：
```
Hardware support: false
CPU does not support feature VMX
Failed to enable virtualization: Unsupported
```

**解决方案**：
- 在支持 VT-x 的物理机或嵌套虚拟化 VM 中运行
- 使用 KVM 配置（`-accel kvm -cpu host`）
- WSL2 不支持，需换环境

### 7.6 KVM 权限问题

**现象**：`KVM: Permission denied`

**解决方案**：
```bash
# 添加用户到 kvm 组
sudo usermod -aG kvm $USER
# 重新登录或执行
newgrp kvm
```

### 7.7 NimbOS rootfs 注入失败

**现象**：`Failed to open .../qemu-x86_64 (NotFound)`

**解决方案**：
1. 安装 libguestfs-tools：`sudo apt install libguestfs-tools`
2. 或使用 sudo 权限挂载 loop 设备
3. 重新运行 `bash scripts/setup_qemu_nimbos.sh`

### 7.8 QEMU 无法启动

**现象**：`qemu-system-aarch64: command not found`

**解决方案**：
```bash
sudo apt-get install qemu-system-arm qemu-system-x86 qemu-utils
```

---

## 八、测试结果验证

### 8.1 成功输出示例

**aarch64 ArceOS**：
```
...
VM[1] boot success
...
Hello, world!
Detected success pattern 'Hello, world!' in QEMU output, terminating QEMU.
```

**aarch64 Linux**：
```
...
Booting Linux on physical CPU ...
Linux version 6.x.x ...
...
test pass!
Detected success pattern 'test pass!' in QEMU output, terminating QEMU.
```

**x86_64 NimbOS**：
```
...
usertests passed!
Detected success pattern 'usertests passed!' in QEMU output, terminating QEMU.
```

### 8.2 失败输出示例

**Panic 错误**：
```
panicked at kernel/src/xxx.rs:xx:xx:
...
Error: Detected failure pattern 'panicked at' in QEMU output.
```

**VMX 不支持**：
```
Hardware support: false
CPU does not support feature VMX
...
System will reboot, press any key to continue ...
Error: Detected failure pattern 'System will reboot...' in QEMU output.
```

---

## 九、参考资料

### 9.1 项目文档

- [AxVisor 集成测试环境](https://arceos-hypervisor.github.io/axvisorbook/docs/design/test)
- [集成测试环境完善](https://github.com/orgs/arceos-hypervisor/discussions/346)
- [开发日志管理规范](https://github.com/orgs/arceos-hypervisor/discussions/197)

### 9.2 相关仓库

- [AxVisor](https://github.com/arceos-hypervisor/axvisor)
- [AxVisor Guest Images](https://github.com/arceos-hypervisor/axvisor-guest)

### 9.3 工具文档

- [QEMU 文档](https://www.qemu.org/documentation/)
- [Rust 安装指南](https://www.rust-lang.org/tools/install)

---

**文档版本**：v1.0  
**最后更新**：2026年2月3日
