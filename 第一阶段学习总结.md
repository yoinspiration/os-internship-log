# 第一阶段学习总结

**阶段时间**：2026年1月20日 - 2026年2月10日  
**实习方向**：AxVisor 自动测试系统开发与完善  
**总结人**：贾一飞  
**总结日期**：2026年2月

---

## 一、阶段目标回顾

### 1.1 原定目标

1. 熟悉 AxVisor 项目结构和代码库
2. 学习现有自动测试系统架构和实现
3. 阅读核心文档
4. 搭建本地开发环境
5. 分析现有硬件平台测试流程
6. 研究 QEMU 虚拟化环境配置
7. 确定 QEMU 环境下的测试方案设计

### 1.2 完成情况

| 目标 | 状态 | 产出 |
|------|------|------|
| 熟悉项目结构 | ✅ 完成 | `AxVisor项目结构分析.md` |
| 学习测试系统 | ✅ 完成 | `测试系统深入分析.md` |
| 阅读核心文档 | ✅ 完成 | `核心文档阅读总结.md` |
| 搭建开发环境 | ✅ 完成 | `环境搭建状态.md` |
| 分析硬件测试流程 | ✅ 完成 | `硬件平台测试流程分析.md` |
| 研究 QEMU 配置 | ✅ 完成 | 多 Guest 测试验证通过 |
| 设计测试方案 | ✅ 完成 | `QEMU测试方案设计.md` |

---

## 二、核心学习内容

### 2.1 AxVisor 项目理解

**项目定位**：
- 基于 Rust 的 Type I hypervisor（统一模块化虚拟机监控器）
- 统一架构支持 x86_64、ARM64 (aarch64)、RISC-V 三种架构
- 模块化设计，功能分解为独立可用的组件

**支持的平台**：
- 虚拟化平台：QEMU（aarch64、x86_64）
- 硬件平台：ROC-RK3568-PC、飞腾派、Orange Pi 5 Plus、EVM3588

**支持的 Guest 系统**：
- ArceOS（Unikernel）
- Linux（Macrokernel OS）
- NimbOS（RTOS System）
- Starry-OS（Macrokernel OS）

### 2.2 自动测试系统架构

**核心原理**：
- 动态加载固件到开发板内存中运行
- 通过分析调试端口输出的 LOG 判断测试结果
- 无需烧录固件，提高测试效率

**两种测试路径**：

| 维度 | 硬件板测试（uboot） | QEMU 测试 |
|------|---------------------|-----------|
| 入口命令 | `cargo xtask uboot` | `cargo xtask qemu` |
| 固件加载 | U-Boot loady / TFTP | QEMU 直接加载 |
| 串口来源 | 物理串口（USB 转 TTL） | 虚拟串口 |
| 电源控制 | 支持 | 不适用 |

**配置层次**：
1. 板级配置：`configs/board/*.toml`
2. 运行配置：`qemu-*.toml` / `uboot.toml`
3. 虚拟机配置：`configs/vms/*.toml`

### 2.3 开发管理规范

**GitHub 核心组件**：
- Repository：代码与开发过程的核心载体
- Project：跨仓库任务整合
- Milestones：仓库内的阶段目标管理
- Issues：任务和问题的基本单元
- Discussions：知识共享和开发计划制定

**开发流程**：
1. 在 Discussion 中制定开发计划（Roadmap）
2. 在 Project 中创建任务，拆分为 Issues
3. 在 Issues 中记录开发过程和问题
4. 完成时记录 Commit HASH，关闭 Issue
5. 使用 Release 功能发布版本

---

## 三、实践成果

### 3.1 本地测试环境搭建

**环境配置**：
- QEMU：qemu-system-aarch64、qemu-system-x86_64
- Rust 工具链：rustup、cargo
- 交叉编译：aarch64-linux-gnu-gcc 等
- 测试工具：ostool

### 3.2 多 Guest 测试验证

**已验证的组合**：

| 架构 | Guest 系统 | 状态 | 成功标志 |
|------|-----------|------|----------|
| aarch64 | ArceOS | ✅ 验证通过 | `Hello, world!` |
| aarch64 | Linux | ✅ 验证通过 | `test pass!` |
| x86_64 | NimbOS | ✅ 验证通过（需 VT-x） | `usertests passed!` |

**测试流程**：
1. 下载镜像：`cargo xtask image download <image_name>`
2. 配置 VM：修改 `configs/vms/*.toml` 中的 `kernel_path`
3. 准备 rootfs：复制到 `tmp/rootfs.img`
4. 执行测试：`cargo xtask qemu --build-config ... --qemu-config ... --vmconfigs ...`

### 3.3 辅助脚本开发

**统一 setup 脚本**（Week 3 完成）：
- `scripts/setup_qemu.sh` - 统一脚本，支持 `--guest arceos|linux|nimbos`
- `scripts/setup_qemu_arceos.sh`、`setup_qemu_linux.sh`、`setup_qemu_nimbos.sh` - 兼容性包装

### 3.4 集成测试环境功能实施（多组织共享）

**runner-wrapper**（Week 3 完成）：
- 基于文件锁的 Runner 并发控制
- 解决多组织共享硬件时的资源竞争问题
- 已贡献到 github-runners 仓库（feat/runner-wrapper-multi-org-lock 分支）

**产出文档**：
- `多组织共享测试环境实施文档.md` - 问题分析、方案选择、部署步骤、验证方法

### 3.5 文档产出

| 文档 | 内容 |
|------|------|
| `AxVisor项目结构分析.md` | 项目目录结构、测试系统架构、配置文件说明 |
| `核心文档阅读总结.md` | 集成测试环境、开发管理规范总结 |
| `硬件平台测试流程分析.md` | ROC-RK3568-PC、飞腾派测试流程 |
| `测试系统深入分析.md` | ostool 工作原理、QEMU 配置分析 |
| `QEMU测试方案设计.md` | 测试方案设计、实施检查清单 |
| `QEMU-aarch64部署文档.md` | aarch64 环境部署指南 |
| `x86_64-NimbOS验证说明.md` | NimbOS 验证完整流程 |
| `多Guest测试记录.md` | 多 Guest 测试详细记录 |
| `环境搭建状态.md` | 环境配置状态记录 |
| **`自动测试系统部署文档.md`** | **v1.5 完整部署指南**（QEMU 与硬件对照、CI 配置、故障排查） |
| **`多组织共享测试环境实施文档.md`** | **runner-wrapper 部署与集成说明** |

---

## 四、遇到的问题与解决方案

### 4.1 路径配置问题

**问题**：VM 配置中 `kernel_path` 和 `rootfs` 路径与实际不一致

**解决**：
- 修改 VM 配置中的 `kernel_path` 为实际下载路径
- 将 rootfs 复制到项目根目录的 `tmp/` 目录

### 4.2 x86_64 虚拟化限制

**问题**：WSL2 环境不支持嵌套虚拟化，无法使用 KVM

**分析**：
- AxVisor x86_64 路径依赖 VT-x/VMX 支持
- TCG 软件虚拟化模式下无法检测到 VMX

**解决**：
- 在支持 VT-x 的原生 Linux 环境中测试
- 创建 `qemu-x86_64-kvm.toml` 配置使用 KVM 加速

### 4.3 NimbOS rootfs 内核注入

**问题**：默认 rootfs 不包含测试程序

**解决**：
- 在 setup 脚本中自动将 `qemu-x86_64_usertests` 注入到 rootfs

### 4.4 x86_64 AMD CPU 兼容性

**问题**：AMD WSL2 环境报错 `CPU does not support feature VMX`

**分析**：AxVisor x86_64 仅支持 Intel VT-x (VMX)，不支持 AMD-V (SVM)

**解决**：在 Intel 环境或原生 Linux 中测试；部署文档中补充 CPU 兼容性说明

### 4.5 多组织共享的「做不了」误解

**问题**：跨组织任务调度、统一任务队列受 GitHub 平台限制

**澄清**：并发控制机制可独立实现，runner-wrapper 已解决资源竞争，使多组织可安全共享硬件

---

## 五、关键收获

### 5.1 技术收获

1. **Hypervisor 架构理解**
   - Type I hypervisor 的工作原理
   - 硬件虚拟化（VT-x/VMX）的依赖关系
   - 多架构支持的设计思想

2. **QEMU 虚拟化**
   - QEMU 配置参数和启动流程
   - KVM vs TCG 的差异和适用场景
   - 虚拟串口和日志捕获机制

3. **Rust 工具链**
   - `cargo xtask` 构建系统
   - 交叉编译配置
   - TOML 配置文件管理

4. **CI/CD 系统**
   - GitHub Actions 工作流配置
   - Self-hosted Runner 部署与多组织共享
   - 测试结果正则匹配（success_regex / fail_regex）

5. **并发控制**
   - flock 文件锁在资源独占场景的应用
   - 平台限制与可实施范围的边界认知

### 5.2 方法论收获

1. **文档驱动开发**：先理解文档，再动手实践
2. **增量验证**：逐步验证每个环节，确保流程可复现
3. **问题记录**：详细记录遇到的问题和解决方案
4. **脚本自动化**：将重复操作封装为脚本，提高效率

---

## 六、下一阶段计划

### 6.1 第二阶段目标（2月10日 - 3月10日）

1. **PR 提交**
   - runner-wrapper 向 github-runners 上游提交 PR
   - setup_qemu.sh 向 axvisor 提交 PR（如尚未合并）

2. **测试自动化脚本扩展**（可选）
   - 扩展 CI 测试脚本
   - 测试结果分析、回归测试

3. **x86 PXE 支持**（可选，需硬件）
   - PXE 服务端搭建
   - x86 固件加载测试

### 6.2 待完成事项

- [ ] 联系蒋奇润，讨论合作分工
- [ ] runner-wrapper PR 提交到 github-runners
- [x] 完成第一阶段学习总结

---

## 七、参考资料

### 7.1 项目文档

- [AxVisor 集成测试环境](https://arceos-hypervisor.github.io/axvisorbook/docs/design/test)
- [集成测试环境完善](https://github.com/orgs/arceos-hypervisor/discussions/346)
- [开发日志管理规范](https://github.com/orgs/arceos-hypervisor/discussions/197)

### 7.2 本地文档

- `os-internship-draft/docs/` - 分析文档
- `os-internship-log/logs/` - 周开发日志
- `自动测试系统部署文档.md` - QEMU 部署完整指南
- `多组织共享测试环境实施文档.md` - 多组织共享方案

---

## 八、阶段总结

第一阶段（1月20日 - 2月10日）超额完成原定目标：

- **学习目标**：项目结构、测试架构、开发规范全部掌握
- **实践目标**：QEMU 三组合测试验证通过，统一 setup 脚本完成
- **文档目标**：自动测试系统部署文档 v1.5、多组织共享实施文档完成
- **功能实施**：多组织共享并发控制（runner-wrapper）已实现并贡献

为第二阶段（QEMU 环境测试功能完善）和第三阶段（集成测试环境功能实施）奠定了坚实基础。

---

**文档版本**：v1.1  
**最后更新**：2026年2月
