# 多组织共享测试环境实施文档

**文档版本**：v1.0  
**创建日期**：2026年2月  
**作者**：贾一飞  
**参考**：[Discussion #341](https://github.com/orgs/arceos-hypervisor/discussions/341)、[Discussion #346](https://github.com/orgs/arceos-hypervisor/discussions/346)

---

## 一、问题背景

### 1.1 核心问题

当多个 GitHub 组织（如 `arceos-hypervisor`、`arceos-org`）的仓库同时触发 CI 时，若共享同一套硬件测试环境，会出现：

| 问题 | 说明 |
|------|------|
| **资源竞争** | 多个 Runner 同时访问串口、电源控制、PXE 等独占资源 |
| **测试冲突** | 不同组织的任务并行执行，互相干扰 |
| **结果不可靠** | 因环境争用导致失败，而非代码问题 |
| **效率低下** | 需手动协调不同组织的测试时间 |

### 1.2 技术原因

- **GitHub Actions 多租户隔离**：Runner 按组织注册，无法跨组织共享任务队列
- **硬件独占性**：串口、电源、网络等不支持并发访问
- **无统一调度**：各组织 Runner 独立运行，无法感知其他组织任务状态

---

## 二、方案选择

[Discussion #341](https://github.com/orgs/arceos-hypervisor/discussions/341) 提出了四种方案：

| 方案 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| **GitHub Enterprise** | 原生支持企业级 Runner Pool | 需付费（约 $21/用户/月） | 有预算的企业 |
| **第三方 CI**（GitLab/Jenkins） | 统一任务队列 | 需迁移/双写 CI 配置 | 可接受平台迁移 |
| **修改 Runner 程序** | 无平台迁移、实现简单 | 需维护包装层 | **开源社区首选** |
| **每组织独立环境** | 完全隔离 | 硬件成本成倍增加 | 资源充足时 |

**本实施采用「方案三：修改自托管 Runner 程序」中的「基于文件锁的简单方案」**，理由：

- 零外部依赖（无需 Redis/etcd）
- 单机部署即可，与现有 github-runners Docker 部署兼容
- 实现简单，易于验证和贡献到上游

---

## 三、实现架构

### 3.1 整体流程

```
┌─────────────────────────────────────────────────────────────┐
│  组织 A 触发 CI  ──┐                                         │
│  组织 B 触发 CI  ──┼──► 各 Runner 收到任务                    │
│  组织 C 触发 CI  ──┘                                         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  runner-wrapper.sh                                           │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  flock -x 200  # 获取锁（阻塞等待）                   │    │
│  │  锁文件: /tmp/github-runner-locks/{RESOURCE_ID}.lock │    │
│  └─────────────────────────────────────────────────────┘    │
│                              │                               │
│              持有锁的 Runner 执行 run.sh                       │
│              其他 Runner 在 flock 处等待                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  硬件测试环境（串口、电源、PXE 等）                           │
│  同一时刻仅一个任务可访问                                     │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 锁机制说明

- **锁类型**：`flock` 排他锁（exclusive）
- **锁范围**：按 `RUNNER_RESOURCE_ID` 区分，同一资源 ID 的 Runner 串行
- **超时**：无超时，任务完成即释放；若 Runner 异常退出，trap 会释放锁
- **多资源**：可为不同硬件设备设置不同 `RUNNER_RESOURCE_ID`（如 `board-rk3568`、`board-phytiumpi`）

---

## 四、部署步骤

### 4.1 前置条件

- 已部署 [github-runners](https://github.com/arceos-hypervisor/github-runners) 或手动注册的 GitHub Actions Runner
- 所有需共享硬件的 Runner 运行在同一台物理机（共享文件系统）
- 系统提供 `flock`（通常随 `util-linux`）

### 4.2 方式一：直接替换 run.sh 调用（物理机部署）

```bash
# 1. 复制 runner-wrapper.sh 到 Runner 目录
cp runner-wrapper/runner-wrapper.sh /home/runner/actions-runner/
chmod +x /home/runner/actions-runner/runner-wrapper.sh

# 2. 设置环境变量（按需选择）
export RUNNER_RESOURCE_ID=hardware-test-1    # 所有共享硬件的 Runner 使用相同 ID
export RUNNER_SCRIPT=/home/runner/actions-runner/run.sh
export RUNNER_LOCK_DIR=/tmp/github-runner-locks  # 可选，默认即此路径

# 3. 修改 systemd 或启动脚本，将原来的：
#    ExecStart=/home/runner/actions-runner/run.sh
# 改为：
#    ExecStart=/home/runner/actions-runner/runner-wrapper.sh
```

### 4.3 方式二：Docker 部署（与 github-runners 集成）

在 `github-runners` 的 Docker 镜像或 docker-compose 中：

```yaml
# docker-compose 示例
services:
  runner-org-a:
    image: ghcr.io/actions/actions-runner:latest
    environment:
      RUNNER_RESOURCE_ID: hardware-test-1
      RUNNER_SCRIPT: /home/runner/run.sh
    volumes:
      - ./runner-wrapper.sh:/home/runner/runner-wrapper.sh:ro
      - /dev/ttyUSB0:/dev/ttyUSB0  # 串口透传
    entrypoint: ["/bin/bash", "-c", "chmod +x /home/runner/runner-wrapper.sh && exec /home/runner/runner-wrapper.sh"]

  runner-org-b:
    image: ghcr.io/actions/actions-runner:latest
    environment:
      RUNNER_RESOURCE_ID: hardware-test-1   # 与 org-a 相同，实现串行
      RUNNER_SCRIPT: /home/runner/run.sh
    volumes:
      - ./runner-wrapper.sh:/home/runner/runner-wrapper.sh:ro
      - /dev/ttyUSB0:/dev/ttyUSB0
    entrypoint: ["/bin/bash", "-c", "chmod +x /home/runner/runner-wrapper.sh && exec /home/runner/runner-wrapper.sh"]
```

**注意**：Docker 容器需共享同一锁目录，可通过 volume 挂载：

```yaml
volumes:
  - /tmp/github-runner-locks:/tmp/github-runner-locks
```

### 4.4 多设备场景

若有多块开发板，可为每块板设置独立资源 ID：

| Runner 标签 | RUNNER_RESOURCE_ID | 说明 |
|-------------|-------------------|------|
| roc-rk3568-pc | board-rk3568 | RK3568 开发板 |
| phytiumpi | board-phytiumpi | 飞腾派 |
| x86-device | board-x86 | x86 开发板 |

这样不同板可并行，同一板上的多组织任务仍串行。

---

## 五、验证方法

### 5.1 基本验证

```bash
# 终端 1：获取锁并长时间占用
RUNNER_RESOURCE_ID=test-lock ./runner-wrapper.sh &
sleep 2

# 终端 2：应阻塞在 "Waiting for lock"
RUNNER_RESOURCE_ID=test-lock ./runner-wrapper.sh &
# 观察输出：⏳ Waiting for lock: test-lock

# 终端 1：kill 第一个进程，终端 2 应获得锁并继续
kill %1
```

### 5.2 多组织 CI 验证

1. 在组织 A 和组织 B 的仓库中同时触发 CI（push 或 workflow_dispatch）
2. 观察 Runner 日志，应看到：
   - 先执行的任务：`✅ Acquired lock for hardware-test-1`
   - 后执行的任务：`⏳ Waiting for lock...`，待前者完成后才 `✅ Acquired lock`
3. 两个任务不应同时访问硬件

---

## 六、与 github-runners 的集成建议

### 6.1 可选集成方式

| 方式 | 说明 |
|------|------|
| **A. 仓库内附带** | 在 github-runners 仓库中新增 `runner-wrapper/runner-wrapper.sh`，README 说明可选启用 |
| **B. 环境变量开关** | 增加 `USE_RUNNER_LOCK=1` 时，entrypoint 调用 wrapper 而非直接 run.sh |
| **C. 独立仓库** | 保持 runner-wrapper 为独立脚本，用户按需下载并配置 |

### 6.2 建议的 README 补充

在 github-runners 的 README 中增加「多组织共享」章节：

```markdown
## 多组织共享硬件测试环境

当多个组织的 Runner 共享同一套硬件（串口、电源控制等）时，可启用锁包装实现串行执行：

1. 设置环境变量：`RUNNER_RESOURCE_ID=hardware-test-1`（所有共享硬件的 Runner 使用相同值）
2. 将 entrypoint 改为 `runner-wrapper.sh`（见 [Discussion #341](https://github.com/orgs/arceos-hypervisor/discussions/341)）
3. 确保所有 Runner 容器/进程共享同一锁目录（默认 `/tmp/github-runner-locks`）
```

---

## 七、局限与扩展

### 7.1 当前局限

- **单机**：文件锁仅在同一主机有效，多机部署需 Redis/etcd 方案（见 Discussion #341 方案 3.1、3.3）
- **无优先级**：先到先得，无法为特定组织设置优先级
- **无超时**：若 Runner 僵死，锁会一直占用直至进程结束

### 7.2 扩展方向

- 增加 `--timeout` 参数，超时后强制释放锁
- 增加锁持有者信息写入锁文件，便于排查
- 多机场景下贡献 Redis 版本的 wrapper 到 github-runners

---

## 八、附录

### 8.1 文件清单

```
os-internship-log/
├── runner-wrapper/
│   └── runner-wrapper.sh    # 文件锁包装脚本
└── 多组织共享测试环境实施文档.md  # 本文档
```

### 8.2 相关链接

- [多组织共享集成测试环境问题分析与解决方案](https://github.com/orgs/arceos-hypervisor/discussions/341)
- [集成测试环境完善](https://github.com/orgs/arceos-hypervisor/discussions/346)
- [github-runners 仓库](https://github.com/arceos-hypervisor/github-runners)
- [GitHub Actions Self-hosted Runner 文档](https://docs.github.com/en/actions/hosting-your-own-runners)
